# מערכת חישוב מיחזור משכנתא - תיעוד טכני

## סקירה כללית

המערכת מחשבת מיחזור משכנתא בהתבסס על פרמטרים ריאליים של השוק הישראלי, כולל:
- ריביות משכנתא עדכניות (קל"צ, משתנה לא צמודה, משתנה צמודה)
- ריביות הלוואות אחרות
- מגבלות רגולטוריות של בנק ישראל
- חוקי משכנתא ישראליים

## מבנה הקבצים

### `utils/mortgageParams.ts`
קובץ הפרמטרים המרכזי המכיל:
- **ריביות משכנתא נוכחיות** (דצמבר 2024)
- **חלוקת תיק סטנדרטית** (שליש לכל סוג)
- **ריביות הלוואות אחרות** (4.5% + 6.2%)
- **מגבלות רגולטוריות** (30 שנים, גיל 67, LTV 75%)
- **עמלות ועלויות**

### `utils/calculator.ts`
מנוע החישוב המעודכן:
- **חישוב ריבית משוקללת** לפי חלוקת התיק
- **בדיקות רגולטוריות** אוטומטיות
- **חישוב PMT מדויק** לפי נוסחאות פיננסיות
- **אימות תקינות** של כל הפרמטרים

## נוסחאות החישוב

### ריבית משוקללת למשכנתא
```
ריבית משוקללת = (קל"צ × 1/3) + (משתנה לא צמודה × 1/3) + (משתנה צמודה × 1/3)
```

### ריבית משוקללת להלוואות אחרות
```
ריבית משוקללת = (4.5% × 1/3) + (6.2% × 2/3)
```

### חישוב החזר חודשי (PMT)
```
PMT = P × [r × (1 + r)^n] / [(1 + r)^n - 1]
כאשר:
P = קרן
r = ריבית חודשית
n = מספר תשלומים
```

## פרמטרים נוכחיים (דצמבר 2024)

### ריביות משכנתא
- **קל"צ (קבועה לא צמודה)**: 4.0%
- **משתנה לא צמודה**: 4.5%
- **משתנה צמודה**: 4.4%

### ריביות הלוואות אחרות
- **שליש ראשון**: 4.5%
- **שני שלישים**: 6.2%

### מגבלות רגולטוריות
- **תקופה מקסימלית**: 30 שנה
- **גיל מקסימלי**: 67 שנה
- **יחס מימון מקסימלי**: 75%
- **החזר מינימלי**: 1,000 ש"ח

## עדכון פרמטרים חודשי

### תהליך העדכון
1. **מעקב אחר הודעות בנק ישראל** על שינויי ריבית
2. **בדיקת עדכוני בנקים** לריביות משכנתא
3. **עדכון הפרמטרים** בקובץ `mortgageParams.ts`
4. **בדיקת השפעה** על חישובים קיימים

### דוגמה לעדכון
```typescript
const updatedParams = updateMortgageParams({
  mortgageRates: {
    fixedRate: 0.041,        // עדכון ל-4.1%
    variableUnlinked: 0.046, // עדכון ל-4.6%
    variableLinked: 0.045,   // עדכון ל-4.5%
  }
});
```

## בדיקות רגולטוריות

המערכת מבצעת בדיקות אוטומטיות:

### בדיקת גיל
- **חישוב תקופה מקסימלית** לפי גיל הלווה
- **התראה** כאשר התקופה חורגת מהמותר

### בדיקת יחס מימון (LTV)
- **חישוב אוטומטי** של יחס החוב לשווי הנכס
- **התראה** כאשר היחס חורג מ-75%

### בדיקת החזר מינימלי
- **וידוא** שההחזר החודשי לא יורד מתחת ל-1,000 ש"ח
- **חישוב מינימום** בהתבסס על הריבית

## אינטגרציה עם הממשק

### Step2Payments
- **סליידר דינמי** עם מגבלות רגולטוריות
- **חישוב בזמן אמת** של התקופה
- **התראות** על חריגות

### Step5Simulator
- **סימולטור אינטראקטיבי** עם בדיקות
- **הצגת ריבית משוקללת**
- **אזהרות רגולטוריות** בזמן אמת

## תחזוקה ועדכונים

### עדכון חודשי מומלץ
1. **בדיקת ריביות** בבנקים הגדולים
2. **מעקב אחר הודעות** בנק ישראל
3. **עדכון פרמטרים** בקוד
4. **בדיקת תקינות** החישובים

### מקורות מידע
- **בנק ישראל**: הודעות על ריבית הבסיס
- **בנק הפועלים, לאומי, דיסקונט**: ריביות משכנתא
- **משרד האוצר**: רגולציות חדשות
- **רשות שוק ההון**: הנחיות עדכניות

## דוגמאות שימוש

### חישוב בסיסי
```typescript
const result = calculateRefinancedPayment(formData);
console.log(`החזר חדש: ${result.newMonthlyPayment}`);
console.log(`תקופה: ${result.termYears} שנים`);
```

### בדיקת תקינות
```typescript
const validation = validateLoanParams(
  loanAmount,
  monthlyPayment,
  termYears,
  borrowerAge,
  propertyValue
);

if (!validation.isValid) {
  console.log('חריגות:', validation.violations);
}
```

## הערות חשובות

1. **דיוק הנתונים**: הפרמטרים מבוססים על נתוני שוק ריאליים
2. **עדכון תקופתי**: יש לעדכן את הפרמטרים מידי חודש
3. **בדיקות רגולטוריות**: המערכת מונעת הצגת אפשרויות לא חוקיות
4. **שקיפות**: כל החישובים מבוססים על נוסחאות פיננסיות מוכרות

המערכת מספקת חישובים מדויקים ואמינים המתבססים על המצב הריאלי בשוק המשכנתאות הישראלי.